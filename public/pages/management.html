<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

	<head>
		<title>Management Page</title>
		<link rel="stylesheet" href="../jslib/bootstrap/css/bootstrap.min.css">
		<script src="../jslib/jquery/jquery-2.1.4.min.js"></script>
		<script src="../jslib/bootstrap/js/bootstrap.min.js"></script>
		<script src="../jslib/ukulele/ukulele.js"></script>
		<script src="../js/Testing.js"></script>
		<script src="../js/Question.js"></script>
		<script src="../jslib/lodash/lodash.min.js"></script>
	</head>
	<body uku-application>
		<ul class="nav nav-tabs" role="tablist" id="myTab" style="display: none">
	    	<li role="presentation" class="active"><a href="#listView" aria-controls="listView" role="tab" data-toggle="tab">listView</a></li>
	    	<li role="presentation"><a href="#detailView" aria-controls="detailView" role="tab" data-toggle="tab">detailView</a></li>
	    </ul>
		<div class="tab-content">
			<div role="tabpanel" class="tab-pane fade in active" id="listView">
				<div class="uku-include" src="components/listview.html"></div>
			</div>
			<div role="tabpanel" class="tab-pane fade" id="detailView">
				<div class="uku-include" src="components/detailview.html"></div>
			</div>
		</div>

		<!--Create Modal -->
		<div class="modal fade" id="createTestingModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<h4 class="modal-title" id="createModalLabel">Create Testing</h4>
					</div>
					<div class="modal-body">
						<form>
							<div class="form-group">
								<label for="nameInput">Testing Name</label>
								<input type="text" class="form-control" id="nameInput" placeholder="Enter the new testing name" uku-value="mgr.newTesting.name">
							</div>
							<div class="form-group">
								<label for="descInput">Description</label>
								<textarea id="descInput" class="form-control" rows="3" uku-value="mgr.newTesting.description"></textarea>
								<!--<input type="text" class="form-control" id="nameInput" placeholder="Enter the description" uku-value="mgr.newTesting.name">-->
							</div>
							<div class="form-group">
								<label for="statusInput">Status</label>
								<select uku-selectedItem="mgr.newTesting.status">
									<option uku-repeat="status in mgr.statusEnum" uku-value ="status.value"  uku-data-item="status">{{status.name}}</option>
								</select>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">
							Close
						</button>
						<button type="button" class="btn btn-primary" uku-onclick="mgr.createTesting()">
							Create
						</button>
					</div>
				</div>
			</div>
		</div>
		<!--Edit Modal-->
		<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<h4 class="modal-title" id="editModalLabel">Edit Testing</h4>
					</div>
					<div class="modal-body">
						<form>
							<div class="form-group">
								<label for="editNameInput">Testing Name</label>
								<input type="text" class="form-control" id="editNameInput" uku-value="mgr.editTesting.name">
							</div>
							<div class="form-group">
								<label for="editDescInput">Description</label>
								<textarea id="editDescInput" class="form-control" rows="3" uku-value="mgr.editTesting.description"></textarea>
								<!-- <input type="text" class="form-control" id="nameInput" placeholder="Enter the description" uku-value="mgr.newTesting.name"> -->
							</div>
							<div class="form-group">
								<label for="statusInput">Status</label>
								<select uku-selectedItem="mgr.editTesting.status">
									<option uku-repeat="status in mgr.statusEnum" uku-value ="status.value"  uku-data-item="status">{{status.name}}</option>
								</select>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">
							Close
						</button>
						<button type="button" class="btn btn-primary" uku-onclick="mgr.updateTesting()">
							Modify
						</button>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script>
		function ManagementController() {
			this.testings = [];
			var self = this;
			this.getTestings = function() {
				$.get("/testing", function(data) {
					var arr = [];
					for (var i = 0; i < data.length; i++) {
						var testing = new Testing();
						testing.convertModel2Entity(data[i]);
						arr.push(testing);
					}
					self.testings = arr;
					uku.refresh();
				});
			};
			
			this.getTestingById = function(id,retFunc){
				$.get("/testing/"+this.editTesting.id, function(data) {
					retFunc(data);
				});
			};
			
			this.beforeOpenCreateTestingPanel = function(){
				this.newTesting = new Testing();
				$("#createTestingModal").modal("show");
			};
			this.createTesting = function() {
				$.post("/testing", self.newTesting, function(data) {
					$('#createTestingModal').modal('hide');
					self.getTestings();
					uku.refresh();
				});
			};

			this.showDetailView = function(testing) {
				this.editTesting = _.clone(testing);
				if(this.editTesting.questions.length === 1){
					if(this.editTesting.questions[0] === ""){
						this.editTesting.questions.pop();
					}
				}
				if(this.editTesting.results.length === 1){
					if(this.editTesting.results[0] === ""){
						this.editTesting.results.pop();
					}
				}
				uku.refresh();
				$('#myTab a:last').tab('show');
			};
			
			this.back2ListView = function(){
				$('#myTab a:first').tab('show');
			};

			this.updateTesting = function() {
				$.ajax({
					url : "/testing/",
					type : "PUT",
					data : this.editTesting,
					success : function() {
						$('#editModal').modal('hide');
						self.getTestings();
					}
				});

			};
			this.newTesting = undefined;
			this.editTesting = undefined;
			this.removeTesting = function(id) {
				$.ajax({
					url : "/testing/" + id,
					type : "DELETE",
					success : function() {
						self.getTestings();
					}
				});
			};
			this.beforeOpenEditTestingPanel = function(testing) {
				this.editTesting = _.clone(testing);
				$('#editModal').modal('toggle');
				uku.refresh();
			};
			
			this.newQuestion = undefined;		
			this.beforOpenCreateQuestionPanel = function(){
				this.newQuestion =  new Question();
				$("#createQuestionModal").modal("show");
			};
			
			this.createQuestion = function(){
				var testingId = this.editTesting.id;
				$.post("/testing/"+testingId+"/question", this.newQuestion, function(data) {
					self.getTestingById(testingId,function(data){
						self.editTesting = data;
						uku.refresh();
						$('#createQuestionModal').modal('hide');
					});
				});
			};
			
			this.removeQuestion = function(id) {
				$.ajax({
					url : "/testing/" + id,
					type : "DELETE",
					success : function() {
						self.getTestings();
					}
				});
			};
			
			this.statusEnum = [{
				"name" : "pending",
				"value" : "pending"
			}, {
				"name" : "running",
				"value" : "running"
			}, {
				"name" : "suspended",
				"value" : "suspended"
			}, {
				"name" : "over",
				"value" : "over"
			}];
		}

		var uku;
		$(document).ready(function() {
			uku = new Ukulele();
			var mgr = new ManagementController();
			uku.registerController("mgr", mgr);
			mgr.getTestings();
			uku.init();
		});

	</script>
</html>